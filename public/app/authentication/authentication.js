angular.module("main").controller("authController",["$scope","$http","appFactory","$state","$location",function($scope,$http,appFactory,$state,$location){appFactory.init($scope),$scope.error="",$scope.genres=appFactory.genres,$scope.chooseGenre=appFactory.chooseGenre;var ref=appFactory.firebase,users=ref.child("users"),usernames=ref.child("usernames"),emails=ref.child("emails");$scope.signIn=function(inputEmail,inputPassword){var email=inputEmail||$scope.credentials.email,password=inputPassword||$scope.credentials.password;$scope.credentials={},ref.authWithPassword({email:email,password:password},function(error,authData){error?console.log("error: ",error):ref.child("users").child(authData.uid).on("value",function(user){console.log(user.val().username),appFactory.user=user.val().username,console.log("success! Logged in",appFactory.user);var state=appFactory.prevRoute.state,params=appFactory.prevRoute.params;appFactory.userInit(),"userProfile"===state||"event"===state?$state.go(state,params):(state=state||"home",$state.go(state))})})},$scope.signUp=function(){var firstname=$scope.credentials.firstname,lastname=$scope.credentials.lastname,username=$scope.credentials.username,password=$scope.credentials.password,email=$scope.credentials.email,image=$scope.credentials.image||"./assets/profile.jpg",chosenGenres=appFactory.chosenGenres,emailFirebase=email.replace(/\./g,"!");emails.child(emailFirebase).on("value",function(em){null===em.val()?usernames.child(username).on("value",function(name){null===name.val()?ref.createUser({email:email,password:password},function(error,userData){error?console.log("Error: ",error):(console.log("userData is ",userData),users.child(userData.uid).set({firstname:firstname,lastname:lastname,username:username,email:email,image:image,chosenGenres:chosenGenres,uid:userData.uid}),usernames.child(username).update({uid:userData.uid}),emails.child(emailFirebase).update({uid:userData.uid}),$scope.credentials={},appFactory.resetGenres(),$scope.error="",$scope.signIn(email,password))}):appFactory.update($scope,function(scope){scope.error="username already exists!"})}):appFactory.update($scope,function(scope){scope.error="email already in use!"})})}}]);