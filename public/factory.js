angular.module("main").factory("appFactory",function($http){var _1="415&427&427&423&426&#419&416&421&412&419&412&429&412&419&.413&416&425&412&409&408&426&412&416&422&.410&422&420&",obj={};obj.prevRoute={state:"home",params:null},obj.notifications={},obj.getNotifications=function(uid,scope){this.auth(function(userData){var notificationRef=obj.firebase.child("users").child(userData.uid).child("notifications");notificationRef.on("child_added",function(a){var key=a.key();a=a.val(),null!==a&&(a.id=key,obj.notifications[key]=a,scope.newNotifications=!0),console.log("appFactory notifications ",obj.notifications)})})},obj.deleteNotification=function(id){this.auth(function(userData){var notificationRef=obj.firebase.child("users").child(userData.uid).child("notifications");notificationRef.child(id).remove(),delete obj.notifications[id]})},obj.deleteAllNotifications=function(){this.auth(function(userData){var notificationRef=obj.firebase.child("users").child(userData.uid).child("notifications");notificationRef.remove(),obj.newNotifications=!1;for(var key in obj.notifications)delete obj.notifications[key]})},obj.getTimeStamp=function(timestamp){timestamp=(new Date).getTime()-timestamp;var days=Math.floor(timestamp/864e5);timestamp%=864e5;var hours=Math.floor(timestamp/36e5);timestamp%=36e5;var minutes=Math.floor(timestamp/6e4);return days?""+days+"d":hours?""+hours+"h":minutes?""+minutes+"m":"1m"},obj.sendNotification=function(recipientUid,data){var notificationRef=obj.firebase.child("users").child(recipientUid).child("notifications");data.timestamp=(new Date).getTime(),notificationRef.push().set(data)},obj.noNotificationsLeft=function(){var keys=Object.keys(obj.notifications);return 0===keys.length},obj.timers={eventCounter:null,participantCounter:null},obj.resetTimers=function(){for(var timers=Object.keys(obj.timers),i=0;i<timers.length;++i)clearTimeout(obj.timers[timers[i]])},obj.userName=null,obj.userInit=function(){var auth=obj.firebase.getAuth();if(null!==auth){var temp=obj.firebase.child("users").child(obj.firebase.getAuth().uid);temp.on("value",function(a){obj.userName=a.val().username})}},obj.accessUserByUid=function(uid,cb){return this.auth(function(user){var ref=obj.firebase.child("users").child(uid);ref.on("value",function(userData){cb.call(this,userData),ref.off()})})},obj.accessUserByUsername=function(username,cb){return this.auth(function(){var ref=obj.firebase.child("usernames").child(username);ref.on("value",function(user){uid=user.val().uid,obj.accessUserByUid(uid,cb),ref.off()})})},obj.accessUidByUsername=function(username,cb){return this.auth(function(){var ref=obj.firebase.child("usernames").child(username);ref.on("value",function(userData){cb.call(this,userData.val().uid),ref.off()})})},obj.followUser=function(username,receiveNotification){return receiveNotification=void 0===receiveNotification?!0:receiveNotification,this.auth(function(user){obj.accessUserByUsername(username,function(friendData){null!==friendData&&(friendData=friendData.val(),obj.firebase.child("users").child(user.uid).child("following").child(friendData.username).set({uid:friendData.uid}),obj.firebase.child("users").child(friendData.uid).child("followers").child(user.uid).update({notifications:receiveNotification}))})})},obj.unfollowUser=function(username){return this.auth(function(user){obj.firebase.child("users").child(user.uid).child("following").child(username).remove(),obj.removeUserFromFollowers(username,user.uid)})},obj.removeUserFromFollowers=function(username,uid){obj.firebase.child("usernames").child(username).on("value",function(unfollowedUser){null!==unfollowedUser&&(unfollowedUid=unfollowedUser.val().uid,obj.firebase.child("users").child(unfollowedUid).child("followers").child(uid).remove())})},obj.getUserFollowList=function(cb){return this.auth(function(user){obj.firebase.child("users").child(user.uid).child("following").on("value",function(list){var result=[];list=list.val();for(var username in list)result.push(list[username]);cb.call(this,result)})})};var userProperties={email:!0,firstname:!0,lastname:!0,lastSessionId:!0};obj.updateUserProperty=function(uid,property,value){return userProperties[property]?void obj.firebase.child("users").child(uid).child(property).set(value):!1},obj.updateEventParticipation=function(scope,reset){this.auth(function(user){obj.accessUserByUid(user.uid,function(userData){userData=userData.val();var userEvent=obj.firebase.child("events").child(userData.lastSessionId).child("participants").child(userData.username);void 0===scope.eventId&&reset?userEvent.remove():userEvent.set({lastKnownTime:(new Date).getTime()})})})},obj.init=function(scope){this.auth(function(userData){obj.resetTimers(),obj.updateEventParticipation(scope,!0)})},obj.auth=function(cb){if(void 0===cb)return null!==obj.firebase.getAuth();var user=this.firebase.getAuth();return null===user?!1:void cb.call(this,user)},obj.unauth=function(){this.init({},!0),this.firebase.unauth()},obj.update=function(scope,cb){scope.$$phase?cb.call(this,scope):scope.$apply(function(){cb.call(this,scope)})};var genres=["Classical","Jazz","Pop","Rock","Blues","Folk","Country","Electronic","Experimental"];obj.genres=genres.reduce(function(array,genre){return array.push({name:genre,selected:!1}),array},[]),obj.chosenGenres=[],obj.chooseGenre=function(genre){if(genre.selected=!genre.selected,genre.selected)obj.chosenGenres.push(genre.name);else{var indexOfGenre=obj.chosenGenres.indexOf(genre.name);obj.chosenGenres.splice(indexOfGenre,1)}},obj.resetGenres=function(){obj.chosenGenres=[],obj.genres.forEach(function(genre){genre.selected=!1})},obj.date={},obj.resetDate=function(){obj.date.eventDate=new Date,obj.date.eventDate.setHours(19),obj.date.eventDate.setMinutes(0),obj.date.eventDate.setSeconds(0),obj.date.eventDate.setMilliseconds(0)};var _=function(x){return x.replace(/\d+|#/g,function(x){return"#"===x?"://":String.fromCharCode(x-100-1-1-1-100-1-100-1-1-1-1-1-1-1)}).split("&").join("")};return obj.dateFilter=function(date,dateView){var show=!0,now=new Date,isInFuture=now.getTime()+36e5<date;if(dateView.futureView)show=isInFuture;else if(dateView.pastView)show=!isInFuture;else if(dateView.start&&dateView.end){var start=dateView.start.getTime(),end=dateView.end.getTime();show=date>=start&&end>=date}return show},obj.genreFilter=function(eventGenres,chosenGenres){var show=!0;return chosenGenres.forEach(function(genre){eventGenres&&-1!==eventGenres.indexOf(genre)||(show=!1)}),show},obj.textFilter=function(eventText,filterText){var show=!0;return filterText=filterText.toLowerCase(),eventText?(eventText=eventText.toLowerCase(),-1===eventText.indexOf(filterText)&&(show=!1)):show=!1,show},obj.firebase=new Firebase(_(_1)),obj});